@model List<ECommerce.Models.Products>

@{
    ViewData["Title"] = "Products";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-2">
        </div>
        <div class="col-md-5">
            <div class="card p-4 shadow-lg" style="width:200%;">
                <div class="row">
                    <div class="col-md-10">
                        <h2>Product List</h2>
                    </div>
                    <div class="col-md-2 mt-2">
                        @*  <a asp-action="Create" class="btn btn-success btn-sm">Add New Products</a> *@
                        <button id="openModal" class="btn btn-success">Add New Products</button>
                    </div>
                </div>
                <br />
                <!-- Table -->
                <table id="productsTable" class="table">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Color</th>
                            <th>Quantity</th>
                            <th>MRP</th>
                            <th>Discount</th>
                            <th>Price</th>
                            <th>Arriving Days</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model)
                        {
                            @if (product.ProductImages.Any())
                            {
                                @foreach (var image in product.ProductImages)
                                {
                                    <tr>
                                        <td>@product.Name</td>
                                        <td>@image.Type</td>
                                        <td>@image.Color</td>
                                        <td>@image.Quantity</td>
                                        @*  <td>
                                            <img src="@image.Image" class="img-thumbnail" width="50" height="50" />
                                        </td> *@
                                        <td>₹@image.MRP</td>
                                        <td>@image.Discount%</td>
                                        <td>₹@image.Price</td>
                                        <td>@image.ArrivingDays</td>
                                        <td style="width:20%;">
                                            <a asp-action="GetById" asp-route-id="@image.ProductId" asp-route-productsImageId="@image.ProductsImageId" class="btn btn-success btn-sm">View</a>

                                            <a asp-action="Edit" asp-route-id="@image.ProductsImageId" class="btn btn-primary btn-sm">Edit</a>
                                            <!-- Separate Delete Button for Each Image -->
                                            <form asp-action="Delete" asp-route-id="@image.ProductsImageId" method="post" style="display:inline;">
                                                <button type="submit" class="btn btn-danger btn-sm"
                                                        onclick="return confirm('Are you sure you want to delete this image?');">
                                                    Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <span>No data available...</span>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-5">
        </div>
    </div>
</div>
<br />


<!-- Add Product Modal -->
<div class="modal fade" id="ProductModal" tabindex="-1" aria-labelledby="ProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="width: 200%;">
            <div class="modal-header">
                <h5 class="modal-title" id="ProductModalLabel">Add Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <!-- Product Name -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold">Product Name</label>
                                <input class="form-control" placeholder="Enter product name" required>
                                <span class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Type -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold">Type</label>
                                <input name="ProductImages[0].Type" class="form-control" placeholder="Type" required>
                            </div>
                        </div>

                        <!-- Color -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold">Color</label>
                                <input name="ProductImages[0].Color" class="form-control" placeholder="Color" required>
                            </div>
                        </div>
                    </div>



                    <div id="imageContainer">
                        <div class="row image-entry">
                            <div class="row">
                                <!-- Large Image (Col-6) -->
                                <div class="col-md-4 mt-3">
                                    <label class="form-label fw-bold">Image (Large) </label>
                                    <div class="img-preview-container" onclick="$('#LargeImageUpload').click();">
                                        <img id="largePreviewImage" src="https://via.placeholder.com/300" class="img-thumbnail" style="width:100%; height:185px;">
                                    </div>
                                    <input type="file" id="LargeImageUpload" name="ImageFiles" class="form-control d-none" accept="image/*">
                                </div>

                                <!-- Medium Image (Col-3) -->
                                <div class="col-md-4 mt-3">
                                    <label class="form-label fw-bold">Image (Medium)</label>
                                    <div class="img-preview-container" onclick="$('#MediumImageUpload').click();">
                                        <img id="mediumPreviewImage" src="https://via.placeholder.com/150" class="img-thumbnail" style="width:100%; height:185px;">
                                    </div>
                                    <input type="file" id="MediumImageUpload" name="MediumImageFile" class="form-control d-none" accept="image/*">
                                </div>

                                <!-- Small Image (Col-3) -->
                                <div class="col-md-4 mt-3">
                                    <label class="form-label fw-bold">Image (Small)</label>
                                    <div class="img-preview-container" onclick="$('#SmallImageUpload').click();">
                                        <img id="smallPreviewImage" src="https://via.placeholder.com/150" class="img-thumbnail" style="width:100%; height:185px;">
                                    </div>
                                    <input type="file" id="SmallImageUpload" name="ImageFiles" class="form-control d-none" accept="image/*">
                                </div>
                            </div>


                            <div class="row">
                                <div class="col-md-12 mt-3">
                                    <div class="mt-3">
                                        <label class="form-label fw-bold">Description</label>
                                        <textarea name="ProductImages[0].Description" class="form-control" placeholder="Enter product Description" required></textarea>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Quantity</label>
                                        <input name="ProductImages[0].Quantity" class="form-control" placeholder="Quantity" required>
                                    </div>
                                </div>

                                <!-- Color -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">MRP</label>
                                        <input name="ProductImages[0].MRP" class="form-control" placeholder="MRP" required>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Discount</label>
                                        <input name="ProductImages[0].Discount" class="form-control" placeholder="Discount" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-4 mt-3">
                                    <label class="form-label">Price</label>
                                    <input type="number" class="form-control price-input" placeholder="Calculated Price" readonly>
                                </div>

                                <div class="col-4 mt-3">
                                    <label class="form-label">Arriving Days</label>
                                    <input type="number" name="ProductImages[0].ArrivingDays" class="form-control arrivingDays-input" placeholder="Arriving Days">
                                </div>
                                <div class="col-4 mt-3">
                                </div>
                            </div>

                            <div class="d-flex mt-3">
                                <button type="button" id="addImage" class="btn btn-primary">Add More</button>
                               @*  &nbsp;&nbsp;
                                <button type="button" class="btn btn-danger remove-image">Remove</button> *@
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="d-flex float-end">
                        <button type="submit" class="btn btn-success">Save Product</button>
                        &nbsp;
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>




<!-- Include jQuery and DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />

<!-- Initialize DataTable -->
<script>
    $(document).ready(function () {
        $('#productsTable').DataTable({
            "paging": true,      // Enable pagination
            "searching": true,   // Enable search box
            "ordering": true,    // Enable column sorting
            "lengthMenu": [5, 10, 25, 50], // Show entries per page options
            "language": {
                "search": "Search Products:"
            }
        });

         $("div.dataTables_filter input").css({
            "margin-bottom": "8px",
            "padding": "8px",
            "border-radius": "5px",
            "border": "1px solid #ccc"
         });
    });


</script>

<script>

    $(document).ready(function () {

         $("#openModal").click(function () {
              $("#ProductModal").modal("show");
         });

       let productList = [];
         let productName = "";

        // Save product name on first input
        $("#productForm input[placeholder='Enter product name']").on("input", function () {
            productName = $(this).val();
        });

        // Handle image preview
        function previewImage(input, previewId) {
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    $("#" + previewId).attr("src", e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Attach change event to file inputs correctly
        $("#LargeImageUpload").change(function () {
            previewImage(this, "largePreviewImage");
        });
        $("#MediumImageUpload").change(function () {
            previewImage(this, "mediumPreviewImage");
        });
        $("#SmallImageUpload").change(function () {
            previewImage(this, "smallPreviewImage");
        });

     // Function to calculate price
        function calculatePrice() {
            let mrp = parseFloat($("input[name='ProductImages[0].MRP']").val()) || 0;
            let discount = parseFloat($("input[name='ProductImages[0].Discount']").val()) || 0;
            let price = mrp - (mrp * discount / 100); // Apply discount percentage

            $(".price-input").val(price.toFixed(2)); // Update calculated price field
        }

        // Recalculate price when MRP or Discount changes
        $(document).on("input", "input[name='ProductImages[0].MRP'], input[name='ProductImages[0].Discount']", function () {
            calculatePrice();
        });



    // Handle "Add More" button
        $("#addImage").click(function () {
            let index = productList.length; // Get current index

            //  Create product data object with only names of images (not full file objects)
            let productData = {
                Name: $("#productForm input[placeholder='Enter product name']").val() || "",
                Type: $(`input[name='ProductImages[${index}].Type']`).val() || "",
                Color: $(`input[name='ProductImages.Color']`).val() || "",
                Description: $(`textarea[name='ProductImages.Description']`).val() || "",
                LargeImage: $("#LargeImageUpload")[0]?.files[0] ? $("#LargeImageUpload")[0].files[0].name : null,
                MediumImage: $("#MediumImageUpload")[0]?.files[0] ? $("#MediumImageUpload")[0].files[0].name : null,
                SmallImage: $("#SmallImageUpload")[0]?.files[0] ? $("#SmallImageUpload")[0].files[0].name : null,
                Quantity: $(`input[name='ProductImages.Quantity']`).val() || "0",
                MRP: $(`input[name='ProductImages.MRP']`).val() || "0",
                Discount: $(`input[name='ProductImages.Discount']`).val() || "0",
                Price: $(".price-input").val() || "0",
                ArrivingDays: parseInt($(`input[name='ProductImages.ArrivingDays']`).val()) || 0
            };

            //  Append the new product to the productList
            productList.push(productData);
            console.log("Updated Product List:", productList);

            //  Reset form fields but keep the product name
            $("#productForm")[0].reset();
            $("#productForm input[placeholder='Enter product name']").val(productData.Name);

            //  Display file names for selected images
            if (productData.LargeImage) {
                $("#largeImageName").text(productData.LargeImage);
            }
            if (productData.MediumImage) {
                $("#mediumImageName").text(productData.MediumImage);
            }
            if (productData.SmallImage) {
                $("#smallImageName").text(productData.SmallImage);
            }
        });

    // Handle "Save Product" button
    $("#productForm").submit(function (event) {
        event.preventDefault();

        if (productList.length === 0) {
            alert("No products added!");
            return;
        }

        let formData = new FormData();
        formData.append("products", JSON.stringify(productList));

        // Append images for each product entry
        let largeFile = $("#LargeImageUpload")[0].files[0];
        let mediumFile = $("#MediumImageUpload")[0].files[0];
        let smallFile = $("#SmallImageUpload")[0].files[0];

        if (largeFile) formData.append(`ImageFiles[0]`, largeFile);
        if (mediumFile) formData.append(`ImageFiles[1]`, mediumFile);
        if (smallFile) formData.append(`ImageFiles[2]`, smallFile);

        console.log("Form Data Before Sending:");
        for (let pair of formData.entries()) {
            console.log(pair[0], pair[1]);
        }

        $.ajax({
            url: "/Admin/Create",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    alert("Products added successfully!");
                    $("#ProductModal").modal("hide");
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert("Failed to save products.");
            }
            });
        });

    }); 


</script>
